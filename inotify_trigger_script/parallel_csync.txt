
## Running csync2 -u for each pair in parallel.

When using SQLite database, deletes from the `dirty` table cause a lock on the database which will stall any other processes accessing the same database. As a test, if the deletes are disabled then multiple processes can run together.

The easy solution is to enable write-ahead logging in SQLite - this queues up the database transactions and allows consistent access until commit. Unfortunately, it is not possible to use WAL because of the non-standard ways that the csync codebase uses transactions.

Various workarounds and hacks could be employed but it doesn't get around the fact that as awesome as SQLite is, it isn't really designed for writes from different processes. The best way forward is changing to a database that accommodates this at its heart.


## Parallelising the csync codebase

I wanted to add multithreading to update operations directly in the csync codebase but the liberal use of global variables especially for database access makes this impossible without careful rewriting.

The best alternative (and not a bad one) is to run several background processes of the csync command for each peer. I've done this and it works well. I thought there would be an overhead for starting up the parallel csync  processes but there is none.


## Install PostgreSQL for Csync

Centos 7:

#install a repository configuration package using the official PostgreSQL repository for CentOS:

yum install -y https://download.postgresql.org/pub/repos/yum/reporpms/EL-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm

yum install -y postgresql14-server postgresql14-devel

# Initialize the database and enable automatic start:
/usr/pgsql-14/bin/postgresql-14-setup initdb
systemctl enable postgresql-14
systemctl start postgresql-14



#Ubuntu 20.04


# Create the file repository configuration:
sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'

# Import the repository signing key:
wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -

# Update the package lists:
sudo apt update

# Install the latest version of PostgreSQL.

sudo apt install postgresql postgresql-contrib postgresql-server-dev-all

systemctl enable postgresql

systemctl start postgresql


+++++++++++++++++++++++++++++++++++++++
#General PostGreSQL usage:

sudo -u postgres psql

#Create user:

sudo -u postgres createuser --interactive

#Create Database

sudo -u postgres createdb csync

#You can check your current connection information by typing (one connected to psql):

\conninfo

+++++++++++++++++++++++++++++++++++++++

### Postgres Server database setup:


By default, the UNIX account "postgres" is locked, which means it cannot be logged in using a password. If you use "sudo passwd postgres", the account is immediately unlocked. It is recommended to keep it locked and use: sudo -u postgres CMD. If this is not possible then set a strong password.

#Create db user matching os user
sudo -u postgres createuser learn4gd

#Create database
sudo -u postgres createdb -O learn4gd csync

#Now psql can be used from user account (e.g. learn4gd)
psql -d csync

#Login via postgres user
sudo -u postgres psql  -d csync

#Some PSQL Commands
\du -  shows users
\dt - show tables
\dt+
\l   - show databases
\l+
show hba_file; - find database config file

#Change login permissions for database
#Use `trust` to allow any user because this data is not sensitive
vim /var/lib/pgsql/14/data/pg_hba.conf

Make sure the host lines has trust method:
local   all     all     trust
host	all	all	127.0.0.1/32	trust
host	all	all	::1/128	trust



Log files
less /var/lib/pgsql/data/log/...


### Csync Build

Csync must be built with Postgres support.

Packaged Library Dependencies
postgresql
postgresql-devel

Configure and Make
./configure --enable-postgres

Line 155 in `configure.ac` will fail if the `pg_config` util is not available. Either install the `postgresql-server-devel` package or hardcode the path to the `libpq.so`:

LIBPQ_SO=$( readlink /usr/lib64/libpq.so | sed -e 's,^.*/,,;s/\(\.so\.[0-9]*\)\..*$/\1/')]

make
make install

#New csync command format
csync2 -D pgsql://learn4gd@localhost/csync -N 1.csync2.test -x

